# ==========================================
# STAGE 1: Builder (Download Everything)
# ==========================================
FROM ubuntu:22.04 AS builder

# Install tools needed strictly for downloading/unzipping
RUN apt-get update && apt-get install -y curl unzip

WORKDIR /downloads

# 1. Download & Unzip AWS CLI
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
    && unzip -q awscliv2.zip

# 2. Download Kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl

# 3. Download ArgoCD CLI
RUN curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 \
    && chmod +x argocd

# 4. Download Helm
RUN curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 \
    && chmod +x get_helm.sh \
    && ./get_helm.sh

# 5. Download uv
#    (Installs to /root/.local/bin by default in this environment)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
RUN cp /root/.local/bin/uv /downloads/uv


# ==========================================
# STAGE 2: Final Runtime
# ==========================================
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PATH="/opt/venv/bin:$PATH"

# 1. Install Basic System Dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-venv \
    software-properties-common \
    wget curl git sshpass openssh-client \
    nano vim \
    gpg lsb-release sudo \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# 2. Install Terraform
RUN wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null \
    && echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list \
    && apt-get update && apt-get install -y terraform \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 3. Copy Tools from Builder
COPY --from=builder /downloads/kubectl /usr/local/bin/
COPY --from=builder /downloads/argocd /usr/local/bin/
COPY --from=builder /usr/local/bin/helm /usr/local/bin/
COPY --from=builder /downloads/uv /usr/local/bin/uv

# 4. Install AWS CLI
COPY --from=builder /downloads/aws /tmp/aws
RUN /tmp/aws/install && rm -rf /tmp/aws

# 5. Install Ansible using uv
RUN uv venv /opt/venv \
    && uv pip install ansible

# 6. User Configuration
#    We explicitly create the 'ubuntu' user because it is missing in minimal docker images
RUN useradd -m -s /bin/bash -u 1000 ubuntu \
    && usermod -aG sudo ubuntu \
    && echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
    && mkdir -p /workspace \
    && chown -R ubuntu:ubuntu /workspace \
    && echo "alias ls='ls --color=auto'" >> /etc/bash.bashrc \
    && echo "alias ll='ls -alF'" >> /etc/bash.bashrc \
    && echo "PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '" >> /etc/bash.bashrc

RUN mkdir -p /etc/ansible && \
    printf '[defaults]\n\
host_key_checking = False\n\
inventory = inventory.ini\n\
\n\
[ssh_connection]\n\
# Fix: Disable ControlMaster to prevent "Connection refused" in Docker/WSL\n\
ssh_args = -o ControlMaster=no -o ControlPath=none\n\
pipelining = True\n' > /etc/ansible/ansible.cfg

USER ubuntu
WORKDIR /home/ubuntu

CMD ["tail", "-f", "/dev/null"]