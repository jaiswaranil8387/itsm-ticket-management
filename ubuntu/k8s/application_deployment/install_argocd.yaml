---
- name: Phase 2 - Install Argo CD & Deploy App
  hosts: master
  become: no
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

  tasks:
    - name: 1. Create Argo CD Namespace
      ansible.builtin.shell:
        # This command is idempotent (safe to run multiple times)
        cmd: "kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -"
      register: ns_create
      changed_when: "'created' in ns_create.stdout"

    - name: 2. Install Argo CD (Stable)
      ansible.builtin.shell:
        cmd: "kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
      register: argo_install
      changed_when: "'created' in argo_install.stdout"

    - name: 3. Wait for Argo CD Server
      ansible.builtin.shell:
        cmd: "kubectl wait --namespace argocd --for=condition=ready pod --selector=app.kubernetes.io/name=argocd-server --timeout=300s"
      changed_when: false

    # --- EXPOSE ARGO CD VIA CLOUDFLARE/INGRESS ---
    - name: 4. Create Ingress for Argo CD
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: argocd-server-ingress
            namespace: argocd
            annotations:
              kubernetes.io/ingress.class: "nginx"
              # Argo CD speaks HTTPS internally, we must tell Nginx to talk HTTPS to the backend
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
              # Pass through for heavy CLI operations
              nginx.ingress.kubernetes.io/proxy-body-size: "0"
          spec:
            rules:
              - host: argocd.aniljaiswar.pp.ua
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: argocd-server
                          port:
                            number: 443

    # --- DEPLOY YOUR APP STACK ---
    - name: 5. Apply Ticketing App (Argo Application)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: ticketing-app-stack
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: https://github.com/jaiswaranil8387/itsm-ticket-management.git
              targetRevision: HEAD
              path: k8s/application_deployment/app
            destination:
              server: https://kubernetes.default.svc
              namespace: ticketing-app

            ignoreDifferences:
            - group: apps
              kind: Deployment
              jsonPointers:
              - /spec/replicas

            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true

    - name: 6. Get Admin Password
      ansible.builtin.shell:
        cmd: "kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
      register: argo_pass
      changed_when: false

    - name: Save Argo CD Password to file
      ansible.builtin.copy:
        content: "ArgoCD URL : https://argocd.aniljaiswar.pp.ua/\nUsername: admin\nPassword: {{ argo_pass.stdout }}\n"
        dest: "{{ playbook_dir }}/argocd_pass.txt"
        mode: '0600'
      delegate_to: localhost

    - debug:
        msg: "Argo CD Password: {{ argo_pass.stdout }}"