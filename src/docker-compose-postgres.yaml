version: '3.8'

services:
  # nosemgrep: yaml.docker-compose.security.writable-filesystem-service.writable-filesystem-service
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"   # The UI (http://localhost:16686)
      - "4317:4317"     # OTLP Receiver (gRPC)
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    security_opt:
      - no-new-privileges:true

  # nosemgrep: yaml.docker-compose.security.writable-filesystem-service.writable-filesystem-service
  ticketing-app:
    build: .
    image: jaiswaranil8387/anil_doc_repo:v7
    container_name: ticketing-app
    init: true
    ports:
      - "5000:5000"
    security_opt:
      - no-new-privileges:true
    
    # --- COMMAND UPDATED ---
    # We use environment variables for config to keep this clean.
    # We just tell it to instrument "python app.py"

    entrypoint: /bin/sh
    command: >
      -c ". .venv/bin/activate &&
        opentelemetry-instrument python app.py"

    # Environment variables
    environment:
      - FLASK_ENV=development
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
      
      # Database Config (Your Remote IPs)
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_NAME=app
      - DB_USER=app
      - DB_PASSWORD=${DB_PASSWORD}
      - PGSSLMODE=disable

      # --- OTel Configuration (The Clean Way) ---
      - OTEL_SERVICE_NAME=ticketing-app
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      # Point to the Jaeger service we defined above
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      # Enable Log Correlation (Links logs to traces)
      - OTEL_PYTHON_LOG_CORRELATION=true
    
    depends_on:
      - jaeger

    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; print(urllib.request.urlopen('http://localhost:5000/health').getcode())"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # nosemgrep: yaml.docker-compose.security.writable-filesystem-service.writable-filesystem-service
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    security_opt:
      - no-new-privileges:true

  # nosemgrep: yaml.docker-compose.security.writable-filesystem-service.writable-filesystem-service
  # db-access:
  #   image: cloudflare/cloudflared:latest
  #   container_name: db-access-client
  #   restart: unless-stopped
  #   # This command creates a TCP listener locally that forwards to your domain
  #   command: access tcp --hostname ticketingdb.aniljaiswar.pp.ua --url tcp://0.0.0.0:5432
  #   security_opt:
  #     - no-new-privileges:true

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid
      - /run:rw,noexec,nosuid
    security_opt:
      - no-new-privileges:true
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASS}
      # Set timezone to match your logs (India Standard Time)
      - GENERIC_TIMEZONE=Asia/Kolkata
      - TZ=Asia/Kolkata
      # Crucial: Allow n8n to reach your Windows Host Postgres
      - DB_HOST=host.docker.internal
    volumes:
      - n8n_data:/home/node/.n8n
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

volumes:
  n8n_data: