<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ITSM Portal</title>
    <!-- Bootstrap CSS 5.3.3 (jsDelivr) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Font Awesome 6.0.0 (cdnjs) - Your hash is correct, kept as-is -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body data-tab="{{ active_tab }}" data-username="{{ session.get('username') }}" data-role="{{ session.get('role') }}">

    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1);">
      <div class="container">
        <a class="navbar-brand fw-bold text-white" href="{{ url_for('index') }}">
            <i class="fas fa-ticket-alt me-2 text-info"></i> ITSM <span class="text-muted fw-light">Portal</span>
        </a>
        <div class="d-flex align-items-center gap-3">
            {% if session.get('username') %}
            <div class="d-flex align-items-center text-light">
                <div class="me-2 text-end lh-1">
                    <div class="small text-muted">Welcome,</div>
                    <div class="fw-bold">{{ session.get('username') }}</div>
                </div>
                <i class="fas fa-user-circle fa-2x text-secondary"></i>
            </div>
            <a class="btn btn-outline-danger btn-sm ms-3" href="{{ url_for('logout') }}">
                <i class="fas fa-sign-out-alt"></i>
            </a>
            {% else %}
            <a class="btn btn-primary btn-sm" href="{{ url_for('login') }}">Login</a>
            {% endif %}
        </div>
      </div>
    </nav>

    <div class="container mt-4">

        <div class="text-center mb-5">
            <h1 class="page-title">Service Operations Center</h1>
            
            <div class="nav-tabs-container shadow-lg">
                <button class="nav-tab active" id="home-tab"><i class="fas fa-chart-pie me-2"></i>Dashboard</button>
                <button class="nav-tab" id="incident-tab"><i class="fas fa-list me-2"></i>Tickets</button>
                <button class="nav-tab" id="search-tab"><i class="fas fa-search me-2"></i>Search</button>
                {% if session.get('role') == 'admin' %}
                    <button class="nav-tab" id="create-tab"><i class="fas fa-plus-circle me-2"></i>New Ticket</button>
                    <button class="nav-tab" id="manage-tab"><i class="fas fa-users-cog me-2"></i>Users</button>
                {% endif %}
            </div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} fade show d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-3"></i>
                        <div>{{ message }}</div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div id="dashboard-section" class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-pie me-2"></i>Priority Distribution</span>
                    </div>
                    <div class="card-body d-flex justify-content-center">
                        <div class="chart-container" style="max-width: 400px; height: 350px;">
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="glass-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-bar me-2"></i>Status Overview</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="search-section" class="d-none mb-4">
            <div class="glass-card p-4">
                <!-- nosemgrep: python.django.security.django-no-csrf-token.django-no-csrf-token -->
                <form action="{{ url_for('search') }}" method="POST" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="text" class="form-control form-control-lg" name="search_query"
                           placeholder="Search incidents by ID, title, or keywords..." value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary px-4"><i class="fas fa-search"></i></button>
                    <a href="{{ url_for('search') }}" class="btn btn-outline-secondary px-3"><i class="fas fa-times"></i></a>
                </form>
            </div>
        </div>

        {% if session.get('role') == 'admin' %}
        <div id="create-ticket-section">
            <div id="ticket-section" class="glass-card mt-4" style="display: none;">
                <div class="card-header border-bottom-0">
                    {% if edit_ticket %}
                        <i class="fas fa-edit me-2"></i>Edit Ticket #{{ edit_ticket[0] }}
                    {% else %}
                        <i class="fas fa-plus me-2"></i>Create New Ticket
                    {% endif %}
                </div>
                <div class="card-body pt-0">
                    <!-- nosemgrep: python.django.security.django-no-csrf-token.django-no-csrf-token -->
                    <form action="{% if edit_ticket %}{{ url_for('edit_ticket_route', ticket_id=edit_ticket[0]) }}{% else %}{{ url_for('add_ticket_route') }}{% endif %}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="title" class="form-label text-muted small">Ticket Title</label>
                                <input type="text" class="form-control" id="title" name="title" required
                                       value="{{ edit_ticket[1] if edit_ticket else '' }}" placeholder="e.g. Server outage in region US-East">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="priority" class="form-label text-muted small">Priority Level</label>
                                <select class="form-select" id="priority" name="priority" required>
                                    {% for level in ['High', 'Medium', 'Low'] %}
                                        <option value="{{ level }}" {% if edit_ticket and edit_ticket[3] == level %}selected{% endif %}>{{ level }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 mb-4">
                                <label for="description" class="form-label text-muted small">Detailed Description</label>
                                <textarea class="form-control" id="description" name="description" rows="5" required placeholder="Describe the issue in detail...">{{ edit_ticket[2] if edit_ticket else '' }}</textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('home-tab').click()">Cancel</button>
                            <button type="submit" class="btn btn-success px-4">
                                {% if edit_ticket %}Update Ticket{% else %}Submit Ticket{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        {% if session.get('role') == 'admin' %}
        <div id="manage-section" class="glass-card mt-4 d-none">
            <div class="card-header">
                <ul class="nav nav-pills card-header-pills" id="userTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active btn-sm" id="add-user-tab" data-bs-toggle="tab" data-bs-target="#add-user" type="button">Add User</button>
                    </li>
                    <li class="nav-item ms-2">
                        <button class="nav-link btn-sm" id="existing-user-tab" data-bs-toggle="tab" data-bs-target="#existing-user" type="button">Existing Users</button>
                    </li>
                </ul>
            </div>
            <div class="card-body tab-content" id="userTabContent">
                <div class="tab-pane fade show active" id="add-user" role="tabpanel">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <!-- nosemgrep: python.django.security.django-no-csrf-token.django-no-csrf-token -->
                            <form method="POST" action="{{ url_for('manage_users') }}" class="p-3">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="action" value="add">
                                <h5 class="mb-4 text-center">Create Account</h5>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Username</label>
                                    <input type="text" class="form-control" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Password</label>
                                    <input type="password" class="form-control" name="password" required>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label small text-muted">Role</label>
                                    <select class="form-select" name="role" required>
                                        <option value="readonly">Readonly</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Create User</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="existing-user" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteUserModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <!-- nosemgrep: python.django.security.django-no-csrf-token.django-no-csrf-token -->
                <form method="POST" action="{{ url_for('manage_users') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="remove">
                    <div class="modal-content" style="background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.1);">
                        <div class="modal-header border-bottom-0">
                            <h5 class="modal-title">Confirm Deletion</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to delete user <strong id="deleteUsernameDisplay" class="text-danger"></strong>?
                            <input type="hidden" name="username" id="deleteUsernameInput">
                        </div>
                        <div class="modal-footer border-top-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Delete User</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div id="incident-section" class="glass-card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list-alt me-2"></i>Active Incidents</span>
                <span class="badge bg-secondary">{{ tickets|length }} Records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                        <tr>
                            <th class="ps-4">ID</th>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for ticket in tickets %}
                            <tr>
                                <td class="ps-4 fw-bold text-muted">#{{ ticket[0] }}</td>
                                <td class="fw-bold">{{ ticket[1] }}</td>
                                <td class="text-muted small text-truncate" style="max-width: 200px;">{{ ticket[2] }}</td>
                                <td>
                                    <span class="badge-status 
                                        {% if ticket[3] == 'High' %}bg-priority-high text-white
                                        {% elif ticket[3] == 'Medium' %}bg-priority-medium text-dark
                                        {% else %}bg-priority-low text-dark{% endif %}">
                                        {{ ticket[3] }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge-status 
                                        {% if ticket[4] == 'Open' %}status-open
                                        {% elif ticket[4] == 'In Progress' %}status-in-progress
                                        {% else %}status-resolved{% endif %}">
                                        {{ ticket[4] }}
                                    </span>
                                </td>
                                <td class="small text-muted">{{ ticket[5] }}</td>
                                <td class="text-end pe-4">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark">
                                            <li><h6 class="dropdown-header">Update Status</h6></li>
                                            <li><a class="dropdown-item" href="{{ url_for('update_status_route', ticket_id=ticket[0], status='Open') }}"><i class="fas fa-folder-open me-2 text-info"></i>Open</a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('update_status_route', ticket_id=ticket[0], status='In Progress') }}"><i class="fas fa-spinner me-2 text-warning"></i>In Progress</a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('update_status_route', ticket_id=ticket[0], status='Resolved') }}"><i class="fas fa-check me-2 text-success"></i>Resolved</a></li>
                                            {% if session.get('role') == 'admin' %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="{{ url_for('edit_ticket_route', ticket_id=ticket[0]) }}"><i class="fas fa-edit me-2"></i>Edit Details</a></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">
                                    <i class="fas fa-folder-open fa-2x mb-3"></i><br>
                                    No tickets found matching your criteria.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS Bundle 5.3.3 (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Chart.js 4.4.1 (jsDelivr) - Generate hash below -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="YOUR_NEW_SHA384_HERE" crossorigin="anonymous"></script>

    <script>
    // Global Config for Chart.js to look good in Dark Mode
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

    const searchTab = document.getElementById('search-tab');
    const incidentTab = document.getElementById('incident-tab');
    const homeTab = document.getElementById('home-tab');
    const createTab = document.getElementById('create-tab');      
    const manageTab = document.getElementById('manage-tab');

    const searchSection = document.getElementById('search-section');
    const incidentSection = document.getElementById('incident-section');
    const ticketSection = document.getElementById('ticket-section');
    const manageSection = document.getElementById('manage-section');
    
    // Group all tabs for easier management
    const tabs = [searchTab, incidentTab, homeTab];
    if (createTab) tabs.push(createTab);
    if (manageTab) tabs.push(manageTab);

    document.addEventListener('DOMContentLoaded', function () {
        const tab = document.body.getAttribute('data-tab');
        
        // Default Logic
        if (tab === 'search') {
            searchTab.click();
        } else if (tab === 'incident') {
            incidentTab.click();
        } else if (tab === 'create' && createTab) {
            createTab.click();
        } else if (tab === 'manage' && manageTab) {
            manageTab.click();
        } else {
            homeTab.click();
        }

        // Auto-hide alerts
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        });
        
        // Listen for Existing Users tab click
        const existingUserTab = document.getElementById('existing-user-tab');
        if(existingUserTab) {
            existingUserTab.addEventListener('shown.bs.tab', () => {
                loadUsers();
            });
        }
    });

    // --- VIEW CONTROLLERS ---
    
    function resetViews() {
        // Hide Everything first
        if(searchSection) searchSection.classList.add('d-none');
        if(manageSection) manageSection.classList.add('d-none');
        showDashboard(false);
        showIncidentList(false);
        showCreateTicket(false);
        
        // Reset Tab styles
        tabs.forEach(tab => tab.classList.remove('active'));
    }

    function showManageSection(show) {
        if (manageSection) manageSection.classList.toggle('d-none', !show);
    }

    function showDashboard(show) {
        const dashboardSection = document.getElementById('dashboard-section');
        if(dashboardSection) dashboardSection.classList.toggle('d-none', !show);
    }

    function showIncidentList(show) {
        // We use d-none class toggle instead of inline styles for cleaner CSS handling
        if(incidentSection) {
            if(show) incidentSection.classList.remove('d-none');
            else incidentSection.classList.add('d-none');
        }
    }

    function showCreateTicket(show) {
        if (ticketSection) {
            ticketSection.style.display = show ? 'block' : 'none';
        }
    }

    // --- TAB EVENT LISTENERS ---

    // 1. HOME TAB
    homeTab.addEventListener('click', () => {
        resetViews();
        homeTab.classList.add('active');
        showDashboard(true);
        
        // Fetch Data for Charts
        fetch('/get_chart_data')
            .then(response => response.json())
            .then(data => {
                renderCharts(data.priority_counts, data.status_counts);
            })
            .catch(error => console.error('Error fetching chart data:', error));
    });

    // 2. INCIDENT TAB
    incidentTab.addEventListener('click', () => {
        resetViews();
        incidentTab.classList.add('active');
        showIncidentList(true);
    });

    // 3. SEARCH TAB
    searchTab.addEventListener('click', () => {
        resetViews();
        searchTab.classList.add('active');
        searchSection.classList.remove('d-none');
        showIncidentList(true); // Show list below search bar
    });

    // 4. CREATE TAB (Admin)
    if (createTab) {
        createTab.addEventListener('click', () => {
            resetViews();
            createTab.classList.add('active');
            showCreateTicket(true);
        });
    }

    // 5. MANAGE TAB (Admin)
    if (manageTab) {
        manageTab.addEventListener('click', () => {
            resetViews();
            manageTab.classList.add('active');
            showManageSection(true);
        });
    }

    // --- CHART LOGIC ---
    let priorityChartInstance = null;
    let statusChartInstance = null;

    function renderCharts(priorityData, statusData) {
        const priorityCtx = document.getElementById('priorityChart');
        const statusCtx = document.getElementById('statusChart');

        if (priorityChartInstance) priorityChartInstance.destroy();
        if (statusChartInstance) statusChartInstance.destroy();

        // Pie Chart
        priorityChartInstance = new Chart(priorityCtx, {
            type: 'doughnut', // Doughnut looks more modern
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: Object.values(priorityData),
                    backgroundColor: ['#f87171', '#fbbf24', '#34d399'],
                    borderColor: 'transparent',
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { usePointStyle: true } }
                }
            }
        });

        // Bar Chart
        statusChartInstance = new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: ['In Progress', 'Open', 'Resolved'],
                datasets: [{
                    label: 'Tickets',
                    data: Object.values(statusData),
                    backgroundColor: ['#a855f7', '#38bdf8', '#22c55e'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- USER MANAGEMENT LOGIC ---
    function confirmDelete(username) {
        document.getElementById('deleteUsernameDisplay').innerText = username;
        document.getElementById('deleteUsernameInput').value = username;
        new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
    }

    function loadUsers() {
        fetch('/existing_users')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = ''; 
                if (data.error) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-danger">Unauthorized</td></tr>';
                } else if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No users found.</td></tr>';
                } else {
                    data.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><div class="fw-bold">${user.username}</div></td>
                            <td><span class="badge bg-secondary">${user.role}</span></td>
                            <td class="text-end">
                                <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete('${user.username}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="3" class="text-danger">Error loading users.</td></tr>';
            });
    }
    </script>
</body>
</html>