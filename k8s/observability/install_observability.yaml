---
- name: Phase 4 - Install Observability Stack (Argo CD)
  hosts: master
  become: no
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

  tasks:
    - name: 1. Apply Observability Applications
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'observability-apps.yaml') }}"

    # --- FIXED: FORCE SYNC USING ANNOTATIONS (Universal Fix) ---
    # This fixes the "repoURL required" error by using annotations instead of spec patching
    
    - name: 2. Force Sync Blackbox Exporter
      ansible.builtin.shell:
        cmd: "kubectl patch application blackbox -n argocd --type merge -p '{\"metadata\": {\"annotations\": {\"argocd.argoproj.io/refresh\": \"hard\"}}}'"
      register: bb_sync
      changed_when: "'patched' in bb_sync.stdout"
      ignore_errors: yes

    - name: 3. Force Sync Prometheus Stack
      ansible.builtin.shell:
        cmd: "kubectl patch application prometheus-stack -n argocd --type merge -p '{\"metadata\": {\"annotations\": {\"argocd.argoproj.io/refresh\": \"hard\"}}}'"
      register: prom_sync
      changed_when: "'patched' in prom_sync.stdout"
      ignore_errors: yes
    # -----------------------------------------------------------

    - name: 4. Wait for Monitoring Namespace
      shell: "kubectl get ns monitoring"
      register: ns_check
      until: ns_check.rc == 0
      retries: 20
      delay: 5

    - name: 5. Wait for Logging Namespace
      shell: "kubectl get ns logging"
      register: log_check
      until: log_check.rc == 0
      retries: 20
      delay: 5

    - debug:
        msg: "Argo CD apps applied and Sync Triggered."