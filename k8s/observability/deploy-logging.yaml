---
- name: Deploy Observability Stack (EFK + Jaeger)
  hosts: master
  become: no
  gather_facts: no

  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

  tasks:
    # ====================================================================
    # SECTION 1: EFK LOGGING STACK
    # ====================================================================

    - name: 1. Create Logging Namespace
      kubernetes.core.k8s:
        name: logging
        api_version: v1
        kind: Namespace
        state: present

    - name: 2. Deploy Elasticsearch (Database)
      kubernetes.core.k8s:
        state: present
        namespace: logging
        definition: "{{ lookup('file', 'elasticsearch.yaml') }}"

    - name: 3. Deploy Kibana (Dashboard)
      kubernetes.core.k8s:
        state: present
        namespace: logging
        definition: "{{ lookup('file', 'kibana.yaml') }}"

    - name: 4. Deploy Fluent Bit (Collector)
      kubernetes.core.k8s:
        state: present
        namespace: logging
        definition: "{{ lookup('file', 'fluent-bit.yaml') }}"

    - name: 5. Restart Fluent Bit DaemonSet (To apply configs)
      ansible.builtin.shell:
        cmd: "kubectl rollout restart daemonset fluent-bit -n logging"

    - name: 6a. Check if metrics-server deployment exists
      ansible.builtin.shell: |
        kubectl get deployment metrics-server -n kube-system
      register: metrics_server_check
      failed_when: false
      changed_when: false

    - name: 6b. Patch Metrics Server (Stop certificate verification spam)
      ansible.builtin.shell: |
        kubectl patch deployment metrics-server -n kube-system --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
      when: metrics_server_check.rc == 0

    # ====================================================================
    # SECTION 2: KIBANA CONFIGURATION
    # ====================================================================

    - name: 7a. Wait for Elasticsearch to be Ready
      kubernetes.core.k8s_info:
        kind: Pod
        name: es-cluster-0
        namespace: logging
      register: es_pod_status
      until: es_pod_status.resources[0].status.phase == 'Running'
      retries: 20
      delay: 15

    # --- NEW TASK: Wait for Kibana to be fully Ready ---
    - name: 7b. Wait for Kibana to be Ready (Required for API calls)
      ansible.builtin.shell:
        cmd: "kubectl wait --namespace logging --for=condition=ready pod --selector=app=kibana --timeout=300s"
      register: kibana_wait
      changed_when: false

    # --- UPDATED TASK: Added Retry Logic ---
    - name: 7c. Create 'logstash-*' Index Pattern in Kibana
      command: >
        kubectl exec -n logging es-cluster-0 -- 
        curl -X POST "http://kibana.logging.svc.cluster.local:5601/api/saved_objects/index-pattern/logstash-pattern"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        -d '{"attributes": {"title": "logstash-*", "timeFieldName": "@timestamp"}}'
      register: kibana_index_result
      # Retry logic: Try 10 times, wait 10s between tries (Total ~100s buffer)
      until: kibana_index_result.rc == 0 or '409' in kibana_index_result.stdout
      retries: 10
      delay: 10
      # Success/Fail Conditions
      changed_when: "'200' in kibana_index_result.stdout"
      failed_when: 
        - kibana_index_result.rc != 0
        - "'409' not in kibana_index_result.stdout"

    # ====================================================================
    # SECTION 3: JAEGER TRACING
    # ====================================================================

    - name: 8. Deploy Jaeger (Service & Ingress)
      kubernetes.core.k8s:
        state: present
        namespace: logging
        definition: "{{ lookup('file', 'jaeger.yaml') }}"

    - name: 9. Deploy deployment yaml
      kubernetes.core.k8s:
        state: present
        namespace: ticketing-app
        definition: "{{ lookup('file', 'active-deployment.yaml') }}"

    - name: Final Summary
      ansible.builtin.debug:
        msg:
          - "-----------------------------------------"
          - "ðŸŽ‰ Observability Deployment Complete!"
          - "âœ… EFK Stack Deployed"
          - "âœ… Kibana Index Pattern Created"
          - "âœ… Jaeger Deployed"
          - "âœ… App Updated to v5 with Tracing"
          - "-----------------------------------------"
