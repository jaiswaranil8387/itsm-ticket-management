---
- name: Phase 5 - Configure Observability (Secrets & Patches)
  hosts: master
  become: no
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  vars:
    monitoring_ns: monitoring
    logging_ns: logging

  tasks:
    # --------------------------------------------------
    # Step 1: Patch Blackbox ConfigMap for TCP
    # --------------------------------------------------
    - name: Patch blackbox configmap with TCP probe
      kubernetes.core.k8s:
        state: patched
        kind: ConfigMap
        name: blackbox-prometheus-blackbox-exporter
        namespace: "{{ monitoring_ns }}"
        merge_type: merge
        definition:
          data:
            blackbox.yml: |
              modules:
                tcp_connect:
                  prober: tcp
                  timeout: 5s

    # --------------------------------------------------
    # Step 2: Copy DB Secret
    # --------------------------------------------------
    - name: 2a. Install jq
      become: yes
      apt:
        name: jq
        state: present
        update_cache: yes

    - name: 2b. Copy DB Secret to Monitoring Namespace
      ansible.builtin.shell: |
        until kubectl get secret app-db-app -n default >/dev/null 2>&1; do 
            echo "Waiting for secret in default namespace..."; 
            sleep 5; 
        done

        kubectl get secret app-db-app -n default -o json | \
        jq 'del(.metadata.ownerReferences, .metadata.uid, .metadata.resourceVersion, .metadata.creationTimestamp) | .metadata.namespace = "{{ monitoring_ns }}"' | \
        kubectl apply -f -
      register: secret_copy
      changed_when: "'created' in secret_copy.stdout or 'configured' in secret_copy.stdout"

    # ====================================================================
    # STEP 3: EFK LOGGING STACK
    # ====================================================================
    - name: 3a. Check if metrics-server deployment exists
      ansible.builtin.shell: |
        kubectl get deployment metrics-server -n kube-system
      register: metrics_server_check
      failed_when: false
      changed_when: false

    - name: 3b. Patch Metrics Server (Stop certificate verification spam)
      ansible.builtin.shell: |
        kubectl patch deployment metrics-server -n kube-system --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
      when: metrics_server_check.rc == 0

    # ====================================================================
    # STEP 4: KIBANA CONFIGURATION
    # ====================================================================

    - name: 4a. Wait for Elasticsearch to be Ready
      kubernetes.core.k8s_info:
        kind: Pod
        name: es-cluster-0
        namespace: logging
      register: es_pod_status
      until: es_pod_status.resources[0].status.phase == 'Running'
      retries: 20
      delay: 15

    # --- NEW TASK: Wait for Kibana to be fully Ready ---
    - name: 4b. Wait for Kibana to be Ready (Required for API calls)
      ansible.builtin.shell:
        cmd: "kubectl wait --namespace logging --for=condition=ready pod --selector=app=kibana --timeout=300s"
      register: kibana_wait
      changed_when: false

    # --- UPDATED TASK: Added Retry Logic ---
    - name: 4c. Create 'logstash-*' Index Pattern in Kibana
      command: >
        kubectl exec -n logging es-cluster-0 -- 
        curl -X POST "http://kibana.logging.svc.cluster.local:5601/api/saved_objects/index-pattern/logstash-pattern"
        -H "kbn-xsrf: true"
        -H "Content-Type: application/json"
        -d '{"attributes": {"title": "logstash-*", "timeFieldName": "@timestamp"}}'
      register: kibana_index_result
      # Retry logic: Try 10 times, wait 10s between tries (Total ~100s buffer)
      until: kibana_index_result.rc == 0 or '409' in kibana_index_result.stdout
      retries: 10
      delay: 10
      # Success/Fail Conditions
      changed_when: "'200' in kibana_index_result.stdout"
      failed_when: 
        - kibana_index_result.rc != 0
        - "'409' not in kibana_index_result.stdout"
