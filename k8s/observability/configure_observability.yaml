---
- name: Phase 5 - Configure Observability (Secrets & Patches)
  hosts: master
  become: no
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  vars:
    monitoring_ns: monitoring
    logging_ns: logging

  tasks:
    # --------------------------------------------------
    # Step 1: Wait & Patch Blackbox (Robust)
    # --------------------------------------------------
    
    # 1. INTELLIGENT WAIT: Don't fail, wait for Argo CD to finish deploying
    - name: 1a. Wait for Blackbox ConfigMap to exist
      ansible.builtin.shell: |
        # Search for any configmap with 'blackbox' in the name and return the FIRST one found
        kubectl get configmaps -n {{ monitoring_ns }} | grep blackbox | awk '{print $1}' | head -n 1
      register: blackbox_cm_check
      until: blackbox_cm_check.stdout != ""
      retries: 20   # Wait up to 100 seconds
      delay: 5
      changed_when: false

    # 2. Capture the exact name found
    - name: 1b. Set ConfigMap Name Variable
      set_fact:
        real_cm_name: "{{ blackbox_cm_check.stdout }}"

    - debug:
        msg: "Found ConfigMap: {{ real_cm_name }}. Proceeding to patch."

    # 3. Patch using the found name
    - name: 1c. Patch blackbox configmap with TCP probe
      kubernetes.core.k8s:
        state: patched
        kind: ConfigMap
        name: "{{ real_cm_name }}"
        namespace: "{{ monitoring_ns }}"
        merge_type: merge
        definition:
          data:
            blackbox.yml: |
              modules:
                tcp_connect:
                  prober: tcp
                  timeout: 5s

    # --------------------------------------------------
    # Step 2: Copy DB Secret
    # --------------------------------------------------
    - name: 2a. Install jq
      become: yes
      apt:
        name: jq
        state: present
        update_cache: yes

    - name: 2b. Copy DB Secret to Monitoring Namespace
      ansible.builtin.shell: |
        until kubectl get secret app-db-app -n default >/dev/null 2>&1; do 
            echo "Waiting for secret in default namespace..."; 
            sleep 5; 
        done

        kubectl get secret app-db-app -n default -o json | \
        jq 'del(.metadata.ownerReferences, .metadata.uid, .metadata.resourceVersion, .metadata.creationTimestamp) | .metadata.namespace = "{{ monitoring_ns }}"' | \
        kubectl apply -f -
      register: secret_copy
      changed_when: "'created' in secret_copy.stdout or 'configured' in secret_copy.stdout"

    # ====================================================================
    # STEP 3: EFK LOGGING STACK
    # ====================================================================
    - name: 3a. Check if metrics-server exists
      shell: "kubectl get deployment metrics-server -n kube-system"
      register: metrics_check
      failed_when: false
      changed_when: false

    - name: 3b. Patch Metrics Server
      shell: |
        kubectl patch deployment metrics-server -n kube-system --type='json' \
          -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
      when: metrics_check.rc == 0

    # ====================================================================
    # STEP 4: KIBANA CONFIGURATION
    # ====================================================================
    - name: 4a. Wait for Kibana Pod
      shell: "kubectl wait --namespace {{ logging_ns }} --for=condition=ready pod --selector=app=kibana --timeout=300s"
      changed_when: false

    - name: 4b. Wait for Kibana API (HTTP 200)
      shell: |
        kubectl run curl-check --image=curlimages/curl --restart=Never --rm -i -- \
          curl -s -o /dev/null -w "%{http_code}" http://kibana.logging.svc.cluster.local:5601/api/status
      register: api_check
      until: api_check.stdout == "200"
      retries: 20
      delay: 10
      changed_when: false
      ignore_errors: yes 

    - name: 4c. Create 'logstash-*' Index Pattern
      shell: |
        kubectl run create-index --image=curlimages/curl --restart=Never --rm -i -- \
          curl -X POST "http://kibana.logging.svc.cluster.local:5601/api/saved_objects/index-pattern/logstash-pattern" \
          -H "kbn-xsrf: true" \
          -H "Content-Type: application/json" \
          -d '{"attributes": {"title": "logstash-*", "timeFieldName": "@timestamp"}}'
      register: kibana_index_result
      failed_when: 
        - kibana_index_result.rc != 0
        - "'409' not in kibana_index_result.stdout"
      changed_when: "'200' in kibana_index_result.stdout"