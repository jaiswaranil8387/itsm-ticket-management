apiVersion: apps/v1
kind: Deployment
metadata:
  name: ticketing-app-green
  namespace: ticketing-app
  labels:
    app: ticketing-app
spec:
  replicas: 2
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: ticketing-app
      version: green
  template:
    metadata:
      labels:
        app: ticketing-app
        version: green
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - ticketing-app
                topologyKey: "kubernetes.io/hostname"
      containers:
        - name: ticketing-app
          image: jaiswaranil8387/anil_doc_repo:v7.21
          imagePullPolicy: Always
          ports:
            - containerPort: 5000

          # ======================================================
          # NEW SECTION: Database Connection Settings
          # ======================================================
          env:
            - name: FLASK_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: flask-secret
                  key: secret-key

            # 1. Hostname: Uses Full DNS to reach DB in 'default' namespace
            - name: DB_HOST
              value: "app-db-rw.default.svc.cluster.local"

            - name: DB_PORT
              value: "5432"

            # 2. Database Name (from your CNPG setup)
            - name: DB_NAME
              value: "app"

            # 3. User (from your CNPG setup)
            - name: DB_USER
              value: "app"

            # 4. Disable SSL: Prevents "Certificate Verify Failed" errors
            #    (Safe here because traffic stays inside the cluster)
            - name: PGSSLMODE
              value: "disable"

            # 5. Password: Reads safely from the Secret you copied
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-db-app
                  key: password
            # --- OpenTelemetry Config ---
            - name: OTEL_SERVICE_NAME
              value: "ticketing-app-k8s"
            # Pointing to the Jaeger service in the 'logging' namespace
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: "http://jaeger.logging.svc.cluster.local:4317"
            # Ensure we use GRPC
            - name: OTEL_EXPORTER_OTLP_PROTOCOL
              value: "grpc"
            - name: OTEL_METRICS_EXPORTER
              value: "none"
            - name: OTEL_LOGS_EXPORTER
              value: "none"
          # ======================================================

          resources:
            requests:
              cpu: "50m"
              memory: "66Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"
          readinessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 5000
            initialDelaySeconds: 15
            periodSeconds: 20