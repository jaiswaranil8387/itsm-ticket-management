---
- name: Deploy Kubernetes Resources and CloudNativePG Operator
  hosts: master
  become: no
  gather_facts: no

  # --- CRITICAL FIX: This makes KUBECONFIG available to ALL tasks ---
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

  tasks:
    - name: Wait until all nodes are Ready
      shell: |
        echo "Checking nodes..."
        READY_NODES=0
        while [ $READY_NODES -lt 2 ]; do
          READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c " Ready" || true)
          echo "Nodes Ready: $READY_NODES... waiting..."
          sleep 5
        done
        echo "All nodes are Ready!"
      args:
        executable: /bin/bash
      register: node_status
      changed_when: false
      failed_when: node_status.rc != 0
          
    - name: 0. Install Python Kubernetes Client (Required for Ansible Modules)
      become: yes     # Switch to Root just for this task
      apt:
        name: python3-kubernetes
        state: present
        update_cache: yes

    # --- 1. INSTALL NGINX ---
    - name: 1a. Install NGINX Ingress Controller
      ansible.builtin.shell:
        cmd: "kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/cloud/deploy.yaml"
      register: ingress_install
      changed_when: "'created' in ingress_install.stdout or 'configured' in ingress_install.stdout"

    - ansible.builtin.debug:
        msg: "NGINX Ingress Controller installed."

    # --- 1b. WAIT FOR NGINX (Crucial Step) ---
    - name: Wait for NGINX Controller Pods to be fully Ready
      ansible.builtin.shell:
        cmd: "kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=120s"
      register: ingress_wait
      changed_when: false

    # Optional: Add a small buffer for the Service to register endpoints
    - name: Buffer sleep for Webhook Service
      ansible.builtin.pause:
        seconds: 10

    - name: Wait for NGINX Ingress Controller to be Ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: ingress-nginx-controller
        namespace: ingress-nginx
        wait: yes
        wait_timeout: 300
        wait_condition:
          type: Available
          status: "True"

    # --- 5. CNPG OPERATOR ---
    - name: 5a. Install CloudNativePG Operator (CNPG)
      ansible.builtin.shell:
        # Added --server-side to fix the "metadata.annotations: Too long" error
        cmd: "kubectl apply --server-side --force-conflicts -f https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.25/releases/cnpg-1.25.0.yaml"
      register: cnpg_install
      changed_when: "'created' in cnpg_install.stdout or 'configured' in cnpg_install.stdout"

   # --- NEW TASK: WAIT FOR CNPG (Fixes Webhook Error) ---
    - name: Wait for CNPG Operator to be Ready
      ansible.builtin.shell:
        cmd: "kubectl wait deployment -n cnpg-system cnpg-controller-manager --for=condition=Available --timeout=120s"
      register: cnpg_wait
      changed_when: false

    - name: Buffer sleep for CNPG Webhook
      ansible.builtin.pause:
        seconds: 10

    # --- 5b. SETUP STORAGE CLASS (Fixes 'Pending' Pods) ---
    - name: 5b. Install Local Path Storage Provisioner
      ansible.builtin.shell:
        cmd: "kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.26/deploy/local-path-storage.yaml"
      register: storage_install
      changed_when: "'created' in storage_install.stdout"

    - name: 5c. Make 'local-path' the Default Storage Class
      ansible.builtin.shell:
        cmd: "kubectl patch storageclass local-path -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'"
      register: storage_patch
      changed_when: "'patched' in storage_patch.stdout"

    - name: Ensure 'ticketing-app' namespace exists
      ansible.builtin.shell: |
        kubectl create namespace ticketing-app --dry-run=client -o yaml | kubectl apply -f -
      register: ns_result
      changed_when: "'created' in ns_result.stdout"

    - name: Create Cloudflare Tunnel Secret
      ansible.builtin.shell: |
        kubectl create secret generic cloudflared-secret \
          --from-literal=token="{{ lookup('env', 'TUNNEL_TOKEN') }}" \
          -n ticketing-app \
          --dry-run=client -o yaml | kubectl apply -f -
      register: cf_secret_result
      changed_when: "'created' in cf_secret_result.stdout or 'configured' in cf_secret_result.stdout"