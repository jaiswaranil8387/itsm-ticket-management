---
- name: Phase 3 - Configure Secret and Restore db
  hosts: master
  become: no
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config

  tasks:
    # --- 6a. Install 'jq' (Required to clean the secret JSON) ---
    - name: 6a. Install jq
      become: yes  # Needs root to install packages
      apt:
        name: jq
        state: present
        update_cache: yes

    # --- 6b. COPY SECRET TO APP NAMESPACE (FIXED) ---
    - name: 6b. Copy DB Secret to App Namespace
      ansible.builtin.shell: |
        # Wait for secret to exist
        until kubectl get secret app-db-app -n default >/dev/null 2>&1; do echo "Waiting..."; sleep 5; done
        
        # Copy secret using jq
        kubectl get secret app-db-app -n default -o json | jq 'del(.metadata.ownerReferences, .metadata.uid, .metadata.resourceVersion, .metadata.creationTimestamp) | .metadata.namespace = "ticketing-app"' | kubectl apply -f -
      register: secret_copy
      changed_when: "'created' in secret_copy.stdout or 'configured' in secret_copy.stdout"

    # --- 7. PATCH NGINX (TCP Passthrough) ---
    - name: 7. Enable TCP passthrough in Ingress-NGINX
      ansible.builtin.shell: |
        # Check if already patched to avoid duplicates
        if ! kubectl get deployment ingress-nginx-controller -n ingress-nginx -o yaml | grep -q "tcp-services-configmap"; then
          kubectl patch deployment ingress-nginx-controller -n ingress-nginx --type='json' \
            -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services"}]'
          echo "patched"
        else
          echo "already_patched"
        fi
      register: tcp_patch_result
      changed_when: "'patched' in tcp_patch_result.stdout and 'already_patched' not in tcp_patch_result.stdout"

    # --- 9. PATCH SERVICE (NodePort) ---
    - name: 9. Expose Postgres NodePort 30432
      ansible.builtin.shell: |
        # Check if port 30432 is already open
        if ! kubectl get svc ingress-nginx-controller -n ingress-nginx -o yaml | grep -q "30432"; then
          kubectl patch svc ingress-nginx-controller -n ingress-nginx --type='json' \
            -p='[{"op":"add", "path":"/spec/ports/-", "value":{"name":"postgres", "port":5432, "targetPort":5432, "protocol":"TCP", "nodePort":30432}}]'
          echo "patched"
        else
          echo "already_patched"
        fi
      register: service_patch_result
      changed_when: "'patched' in service_patch_result.stdout and 'already_patched' not in service_patch_result.stdout"

    # --- 10. DATABASE RESTORE ---
    - name: 10a. Upload backup file to Master Node
      copy:
        src: backup.sql
        dest: /tmp/backup.sql

    - name: 10b. Restore Postgres Database
      ansible.builtin.shell: |
        echo "Waiting for Postgres Pod to be created..."

        # 1. Loop until the Pod exists (Max 20 retries * 5 seconds = 100s)
        ATTEMPTS=0
        until kubectl get pod -l role=primary,cnpg.io/cluster=app-db -n default -o jsonpath='{.items[0].metadata.name}' >/dev/null 2>&1; do
            if [ $ATTEMPTS -ge 20 ]; then
                echo "Timeout waiting for pod creation"
                exit 1
            fi
            echo "Pod not found yet... waiting 5s"
            sleep 5
            ATTEMPTS=$((ATTEMPTS+1))
        done
        # 2. Wait for DB to be ready
        kubectl wait --for=condition=Ready pod -l role=primary,cnpg.io/cluster=app-db -n default --timeout=300s

        # 3. Get Pod Name
        PG_POD=$(kubectl get pods -l role=primary,cnpg.io/cluster=app-db -n default -o jsonpath='{.items[0].metadata.name}')

        # 4. Restore
        kubectl exec -i -n default ${PG_POD} -- psql -U postgres -d app < /tmp/backup.sql
      register: db_restore_result
      ignore_errors: yes

    - name: Final Summary
      ansible.builtin.debug:
        msg:
          - "-----------------------------------------"
          - "ðŸŽ‰ Deployment Complete!"
          - "Postgres NodePort: 30432"
          - "-----------------------------------------"
