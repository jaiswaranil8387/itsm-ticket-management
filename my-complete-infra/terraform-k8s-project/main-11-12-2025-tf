data "aws_vpc" "default" {
  default = true
}

resource "aws_security_group" "k8s_cluster_sg" {
  name        = "k8s-cluster-sg"
  description = "Kubernetes cluster security group recreated from console"
  vpc_id      = data.aws_vpc.default.id

  # --------------------
  # INGRESS RULES
  # --------------------

  # 1) Allow all traffic from itself (console had this rule)
  ingress {
    description = "All internal self-traffic"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    self        = true
  }

  # 2) SSH
  ingress {
    description = "SSH from anywhere"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 3) HTTP
  ingress {
    description = "HTTP"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 4) HTTPS
  ingress {
    description = "HTTPS"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 5) Kubernetes API
  ingress {
    description = "Kubernetes API"
    from_port   = 6443
    to_port     = 6443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 6) NodePort TCP public
  ingress {
    description = "NodePort TCP"
    from_port   = 30000
    to_port     = 32767
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 7) NodePort UDP public
  ingress {
    description = "NodePort UDP"
    from_port   = 30000
    to_port     = 32767
    protocol    = "udp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 8) Grafana
  ingress {
    description = "Grafana"
    from_port   = 3000
    to_port     = 3000
    protocol    = "tcp"
    cidr_blocks = ["49.47.3.201/32"]
  }

  # 9) Postgres Ingress (30432)
  ingress {
    description = "Postgres ingress"
    from_port   = 30432
    to_port     = 30432
    protocol    = "tcp"
    cidr_blocks = ["49.47.3.0/24"]
  }

  # 10) ALB / 5000
  ingress {
    description = "ALB port 5000"
    from_port   = 5000
    to_port     = 5000
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # 11) TargetGroupBinding
  ingress {
    description = "TargetGroupBinding"
    from_port   = 31863
    to_port     = 31863
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # ------------------------
  # SG â†’ SG RULES (now referencing NEW SG)
  # ------------------------

  ingress {
    description              = "etcd client/peer"
    from_port                = 2379
    to_port                  = 2380
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "kubelet API"
    from_port                = 10250
    to_port                  = 10250
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "kube-scheduler"
    from_port                = 10251
    to_port                  = 10251
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "kube-controller-manager"
    from_port                = 10252
    to_port                  = 10252
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "Calico VXLAN"
    from_port                = 4789
    to_port                  = 4789
    protocol                 = "udp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "Calico CNI (8472)"
    from_port                = 8472
    to_port                  = 8472
    protocol                 = "udp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "Calico BGP TCP"
    from_port                = 179
    to_port                  = 179
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "Calico BGP UDP"
    from_port                = 179
    to_port                  = 179
    protocol                 = "udp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "NodePort TCP (cluster internal)"
    from_port                = 30000
    to_port                  = 32767
    protocol                 = "tcp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id

  }

  ingress {
    description              = "NodePort UDP (cluster internal)"
    from_port                = 30000
    to_port                  = 32767
    protocol                 = "udp"
	self        = true # <-- CORRECTED
	#   source_security_group_id = aws_security_group.k8s_cluster_sg.id
  }

  # ============================================================
  # OUTBOUND RULES (Egress)
  # ============================================================

  # --- 1. General Internet Access (For updates, downloading Docker images) ---
  
  egress {
    description = "All outbound"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "Calico VXLAN (Self)"
    from_port   = 4789
    to_port     = 4789
    protocol    = "tcp"
    self        = true
  }  

  egress {
    description = "Calico BGP (Self)"
    from_port   = 179
    to_port     = 179
    protocol    = "udp"
    self        = true
  }
  
  egress {
    description = "Calico/Flannel Optional (Self)"
    from_port   = 8472
    to_port     = 8472
    protocol    = "tcp"
    self        = true
  }

  egress {
    description = "DNS (UDP)"
    from_port   = 53
    to_port     = 53
    protocol    = "udp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "DNS (TCP)"
    from_port   = 53
    to_port     = 53
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "HTTP (Internet)"
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "HTTPS (Internet)"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  # --- 2. Internal Cluster Communication (Self) ---

  egress {
    description = "Kubelet API (Self)"
    from_port   = 10250
    to_port     = 10250
    protocol    = "tcp"
    self        = true
  }

  egress {
    description = "Etcd Communication (Self)"
    from_port   = 2379
    to_port     = 2380
    protocol    = "tcp"
    self        = true
  }

  egress {
    description = "Calico BGP (Self)"
    from_port   = 179
    to_port     = 179
    protocol    = "tcp"
    self        = true
  }

  egress {
    description = "Calico VXLAN (Self)"
    from_port   = 4789
    to_port     = 4789
    protocol    = "udp"
    self        = true
  }

  egress {
    description = "Calico/Flannel Optional (Self)"
    from_port   = 8472
    to_port     = 8472
    protocol    = "udp"
    self        = true
  }

  egress {
    description = "NodePort service"
    from_port   = 30000
    to_port     = 32767
    protocol    = "tcp"
    self        = true
  }

  egress {
    description = "NodePort service"
    from_port   = 30000
    to_port     = 32767
    protocol    = "udp"
    self        = true
  }


  tags = {
    Name = "k8s-cluster-sg"
  }
}
# 3. Create Master Node
module "k8s_master" {
  source            = "./modules/k8s_node"
  ami_id            = "ami-087d1c9a513324697"   # Ubuntu 22.04 (Mumbai)
  instance_type     = "t3.medium"
  server_name       = "K8s-Master"
  key_name          = "flask-key"                # <--- REPLACE with your actual Key Name
  security_group_id = aws_security_group.k8s_cluster_sg.id
}

# 4. Create Worker Node
module "k8s_worker" {
  source            = "./modules/k8s_node"
  ami_id            = "ami-087d1c9a513324697"   # Ubuntu 22.04 (Mumbai)
  instance_type     = "t3.medium"
  server_name       = "K8s-Worker"
  key_name          = "flask-key"                # <--- REPLACE with your actual Key Name
  security_group_id = aws_security_group.k8s_cluster_sg.id
}


# This generates the inventory.ini file automatically!
resource "local_file" "ansible_inventory" {
  content = <<EOT
[master]
${module.k8s_master.public_ip} ansible_user=ubuntu ansible_ssh_private_key_file=./flask-key.pem

[workers]
${module.k8s_worker.public_ip} ansible_user=ubuntu ansible_ssh_private_key_file=./flask-key.pem
  EOT
  filename = "../cluster_setup/inventory.ini"
}
