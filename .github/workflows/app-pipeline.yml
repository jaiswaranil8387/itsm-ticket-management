name: Python Linting (Flake8)

on:
  push:
    branches: [ "master" ]  # <--- CHANGED to master
    paths:
      - 'src/**'
  pull_request:
    branches: [ "master" ]  # <--- CHANGED to master
    paths:
      - 'src/**'

permissions:
  contents: write

jobs:
  ci-cd-pipeline:
    name: "CI/CD Pipeline"
    runs-on: ubuntu-latest

    steps:
    # Step 1: Clone your code so the runner can see it
    - name: Checkout Code
      uses: actions/checkout@v4

    # Step 2: Install Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    # Step 3: Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install your app dependencies (Flask, psycopg2, etc.)
        if [ -f src/requirements.txt ]; then pip install -r src/requirements.txt; fi
        # Create a requirements-dev.txt locally first with: flake8, pytest, bandit, semgrep
        if [ -f src/requirements-dev.txt ]; then pip install -r src/requirements-dev.txt; fi

    # Step 4: Run Flake8 ONLY on the 'src' folder
    - name: Run Flake8
      run: |
        # Scan only the 'src' folder. 
        # --exit-zero means it will show errors but won't fail the build (Green checkmark).
        # Remove --exit-zero if you want it to Fail (Red X) on bad code.
        flake8 src/ --count --exit-zero --max-complexity=11 --max-line-length=127 --statistics

    - name: Run Tests
      run: |
        cd src
        python -m pytest test/ -v

    - name: Run Bandit Security Scan
      run: |
        # -r: Recursive (scans all files in src/)
        # -ll: Only show Medium and High severity issues (skips Low noise)
        # --exit-zero: Optional. If you want the build to PASS even if risks are found, keep this flag.
        # Remove --exit-zero if you want the build to FAIL on security risks.
        bandit -r src/ -ll --exit-zero

    - name: Run pip-audit Security Scan
      run: |
        # --desc: Show vulnerability descriptions
        # || true: Continue even if vulnerabilities are found (optional, remove if you want to fail on vulnerabilities)
        cd src && pip-audit --desc || true

    - name: Run Semgrep Security Scan
      run: |
        # Run semgrep scan with auto config on src directory
        # --config=auto: Use automatic configuration
        # || true: Continue even if findings are found (optional, remove if you want to fail on security issues)
        semgrep scan --config=auto src || true

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: Calculate Version
      run: |
        FILE_PATH="k8s/application_deployment/app/active-deployment.yaml"
        
        # 1. Read the base version (e.g., v7) from the file
        #    grep finds "image: ...:v7", cut grabs just the "7"
        # BASE_VERSION=$(grep -oP 'image: .*?:\K.*' "$FILE_PATH" | sed 's/v//')
        BASE_VERSION=$(grep -oP 'image: .*?:v\K[0-9]+' "$FILE_PATH")
        
        # 2. Combine Base Version + GitHub Run Number
        #    If Base is "7" and Run Number is "45", result is "v7.45"
        NEW_VERSION="v${BASE_VERSION}.${{ github.run_number }}"
        
        echo "Calculated Version: $NEW_VERSION"
        
        # 3. Save to ENV for the next steps
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

    - name: Build Docker Image
      run: |
        docker build -t jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }} ./src

    # 2. Run Trivy on the IMAGE (not the filesystem)
    - name: Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@0.29.0
      with:
        image-ref: 'jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }}' # Must match the tag above
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        # Optional: If you want to use your ignore file
        trivyignores: './src/reports/.trivyignore'

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Docker Image
      run: |
        docker push jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }}
        
        # Optional: Also push 'latest' tag so it's easy to find
        docker tag jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }} jaiswaranil8387/anil_doc_repo:latest
        docker push jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }}
        docker push jaiswaranil8387/anil_doc_repo:latest

    - name: Update K8s Manifest & Push to GitHub
      run: |
        # 3. FIXED GIT CONFIG SYNTAX
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Update the YAML file
        sed -i "s|image: jaiswaranil8387/anil_doc_repo:.*|image: jaiswaranil8387/anil_doc_repo:${{ env.NEW_VERSION }}|g" k8s/application_deployment/app/active-deployment.yaml
        
        # Commit and Push
        git add k8s/application_deployment/app/active-deployment.yaml
        git commit -m "Auto-update image version to ${{ env.NEW_VERSION }} [skip ci]"
        git push origin HEAD:master